<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>XAU PREDATOR â€“ FULL EXECUTION ENGINE</title>
<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
<style>
:root{
  --bg:#050505;--card:#111;--text:#eee;--accent:#00ffff;
  --wait:#444;--arming:#ffcc00;--enter:#00ff66;--locked:#ff4444;
  --h1:#bf00ff;--m15:#ffff00;--m5:#00ff00;--m1:#ffffff;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;outline:none}
body{
  margin:0;background:var(--bg);color:var(--text);
  font-family:Consolas,monospace;height:100vh;overflow:hidden;
  display:flex;flex-direction:column;padding:8px;user-select:none;
}
.grid{display:grid;grid-template-rows:1fr auto;gap:8px;height:100%}
.box{background:var(--card);border:1px solid #333;border-radius:8px;overflow:hidden;position:relative}
#chart{width:100%;height:100%}
.ind{position:absolute;bottom:0;left:0;height:6px;width:100%;background:var(--wait);transition:0.3s;z-index:10}
.sidebar{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.card{background:#000;border:1px solid #222;border-radius:6px;padding:8px;text-align:center}
.label{font-size:10px;color:#666;text-transform:uppercase;letter-spacing:1px}
.val{font-size:18px;font-weight:bold}
#price{font-size:28px;color:var(--accent)}
#reason{grid-column:span 2;color:var(--arming);min-height:36px;display:flex;align-items:center;justify-content:center;font-size:11px;padding:4px}
#debug{grid-column:span 2;font-size:10px;color:#ff4444;background:#1a0000;padding:4px}
#log{grid-column:span 2;height:85px;overflow-y:auto;font-size:11px;color:#00ff66;text-align:left;border:1px solid #222;padding:4px;background:#050505}
.btns{grid-column:span 2;display:grid;grid-template-columns:1fr 1fr;gap:6px}
.btn{padding:16px;border:none;border-radius:6px;font-weight:bold;color:#fff;opacity:0.15;transition:0.2s;font-size:14px;cursor:pointer}
.buy{background:#00ff66;color:#000}
.sell{background:#ff4444;color:#fff}
.active{opacity:1;box-shadow:0 0 20px currentColor;transform:scale(0.98);border:2px solid #fff}
</style>
</head>
<body>
<div class="grid">
  <div class="box">
    <div id="chart"></div>
    <div id="ind" class="ind"></div>
  </div>
  <div class="sidebar">
    <div class="card" style="grid-column:span 2">
      <div id="price" class="val">0.00</div>
      <div id="raw" style="font-size:10px;color:#444">RAW: 0.0000</div>
    </div>
    <div class="card"><div class="label">Bias</div><div id="bias" class="val">-</div></div>
    <div class="card"><div class="label">State</div><div id="state" class="val">WAIT</div></div>
    <div id="reason" class="card">BOOTING ENGINE...</div>
    <div id="log" class="card"></div>
    <div id="debug" class="card">STATUS: INITIALIZING</div>
    <div class="btns">
      <button id="buyBtn" class="btn buy" onclick="manualTrigger('BUY')">EXECUTE BUY</button>
      <button id="sellBtn" class="btn sell" onclick="manualTrigger('SELL')">EXECUTE SELL</button>
    </div>
  </div>
</div>

<script>
/* ================= ENGINE CORE ================= */
const WS_URL = "wss://stream.binance.com:9443/ws/paxgusdt@trade";
let ws, lastTick=0, state="WAIT", bias="WAIT", lastState="WAIT";
let rawHigh=0, rawLow=0, smoothPrice=0;
let entryPrice=0, slPrice=0, tpPrice=0;
let missions = { h1: 0, m15: 0, m5: 0, m1: 0 };
let missionAchieved = { h1: false, m15: false, m5: false, m1: false };

/* ================= CHART CONFIG ================= */
const chart = LightweightCharts.createChart(document.getElementById("chart"), {
    layout: { backgroundColor: "#050505", textColor: "#d1d4dc" },
    grid: { vertLines: { color: "#111" }, horzLines: { color: "#111" } },
    timeScale: { timeVisible: true, secondsVisible: true },
    crosshair: { mode: LightweightCharts.CrosshairMode.Normal }
});
const candleSeries = chart.addCandlestickSeries();
const zU = chart.addLineSeries({ color: "rgba(255,255,255,0.05)", title: 'Zone High' });
const zL = chart.addLineSeries({ color: "rgba(255,255,255,0.05)", title: 'Zone Low' });

// Order Lines
const lineEntry = chart.addLineSeries({ color: "#00ffff", lineStyle: 2, title: 'ENTRY' });
const lineSL = chart.addLineSeries({ color: "#ff4444", lineStyle: 3, title: 'SL' });
const lineTP = chart.addLineSeries({ color: "#00ff66", lineStyle: 3, title: 'TP' });

// Mission Lines (High Accuracy Colors)
const mLineH1 = chart.addLineSeries({ color: "#bf00ff", lineWidth: 2 });  // Purple
const mLineM15 = chart.addLineSeries({ color: "#ffff00", lineWidth: 2 }); // Yellow
const mLineM5 = chart.addLineSeries({ color: "#00ff00", lineWidth: 2 });  // Green
const mLineM1 = chart.addLineSeries({ color: "#ffffff", lineWidth: 2 });  // White

/* ================= UTILS ================= */
function logMsg(m){
    const logEl = document.getElementById("log");
    const d = document.createElement("div");
    d.textContent = `[${new Date().toLocaleTimeString()}] ${m}`;
    logEl.prepend(d);
    if(logEl.childNodes.length > 50) logEl.removeChild(logEl.lastChild);
}

function beep(freq = 880) {
    try {
        const a = new (window.AudioContext || window.webkitAudioContext)();
        if(a.state === 'suspended') a.resume();
        const o = a.createOscillator(); const g = a.createGain();
        o.connect(g); g.connect(a.destination); o.frequency.value = freq;
        g.gain.value = 0.05; o.start(); o.stop(a.currentTime + 0.1);
    } catch(e){}
}

/* ================= EXECUTION LOGIC ================= */
function manualTrigger(dir) {
    if (state === "LOCKED") {
        state = "WAIT";
        entryPrice = 0;
        logMsg("ENGINE RESET - READY");
        return;
    }
    executeTrade(dir, smoothPrice);
}

function executeTrade(dir, price) {
    state = "LOCKED";
    entryPrice = price;
    const offset = 0.45; 
    slPrice = dir === "BUY" ? price - offset : price + offset;
    tpPrice = dir === "BUY" ? price + (offset * 2) : price - (offset * 2);
    
    beep(1200);
    navigator.vibrate?.([300, 100, 300]);
    logMsg(`ORDER EXECUTED: ${dir} @ ${price.toFixed(2)}`);
}

function updateEngine(raw) {
    try {
        smoothPrice = smoothPrice ? smoothPrice * 0.8 + raw * 0.2 : raw;
        const now = Math.floor(Date.now() / 1000);

        // 1. Mission Logic (Story & Habit)
        if (!rawHigh || smoothPrice > rawHigh) rawHigh = smoothPrice;
        if (!rawLow || smoothPrice < rawLow) rawLow = smoothPrice;

        const range = rawHigh - rawLow;
        // Penyelarasan Mission Price
        if (!missions.m15) missions.m15 = rawLow + (range * 0.75); // S/R Upper
        if (!missions.m5) missions.m5 = rawLow + (range * 0.25);  // S/R Lower
        if (!missions.m1) missions.m1 = (rawHigh + rawLow) / 2;   // Pivot

        // Auto Delete Achieved Mission (1 hour rule simplified)
        ["m15", "m5", "m1"].forEach(key => {
            if (Math.abs(smoothPrice - missions[key]) < 0.03) {
                if (!missionAchieved[key]) {
                    logMsg(`MISSION ${key.toUpperCase()} REACHED`);
                    missionAchieved[key] = true;
                    setTimeout(() => { missions[key] = 0; missionAchieved[key] = false; }, 3600000);
                }
            }
        });

        // 2. Bias & State Machine
        bias = (smoothPrice > (rawHigh + rawLow) / 2) ? "BUY" : "SELL";

        if (state !== "LOCKED") {
            const targetMission = bias === "BUY" ? missions.m15 : missions.m5;
            const dist = Math.abs(smoothPrice - targetMission);

            if (dist < 0.15) {
                state = "ARMING";
                document.getElementById("reason").textContent = `APPROACHING ${bias} MISSION ZONE`;
            } else {
                state = "WAIT";
                document.getElementById("reason").textContent = "SCANNING MARKET HABIT";
            }

            // Entry Confirmation
            if (state === "ARMING" && ((bias === "BUY" && smoothPrice > targetMission) || (bias === "SELL" && smoothPrice < targetMission))) {
                state = "ENTER";
                document.getElementById("reason").textContent = "HABIT CONFIRMED - READY";
                beep(660);
            }
        } else {
            // Monitor Trade
            if ((entryPrice > 0) && ((bias === "BUY" && smoothPrice >= tpPrice) || (bias === "SELL" && smoothPrice <= tpPrice))) {
                logMsg("EXIT: TAKE PROFIT"); state = "WAIT"; entryPrice = 0;
            } else if ((entryPrice > 0) && ((bias === "BUY" && smoothPrice <= slPrice) || (bias === "SELL" && smoothPrice >= slPrice))) {
                logMsg("EXIT: STOP LOSS"); state = "WAIT"; entryPrice = 0;
            }
        }

        // 3. UI Update
        document.getElementById("bias").textContent = bias;
        document.getElementById("bias").style.color = bias === "BUY" ? "#00ff66" : "#ff4444";
        document.getElementById("state").textContent = state;
        document.getElementById("ind").style.background = `var(--${state.toLowerCase()})`;
        
        document.getElementById("buyBtn").className = `btn buy ${state === "ENTER" && bias === "BUY" ? "active" : ""}`;
        document.getElementById("sellBtn").className = `btn sell ${state === "ENTER" && bias === "SELL" ? "active" : ""}`;

        // 4. Chart Update
        zU.setData([{ time: now-60, value: rawHigh }, { time: now+10, value: rawHigh }]);
        zL.setData([{ time: now-60, value: rawLow }, { time: now+10, value: rawLow }]);
        
        if (state === "LOCKED" && entryPrice > 0) {
            lineEntry.setData([{ time: now-60, value: entryPrice }, { time: now+10, value: entryPrice }]);
            lineSL.setData([{ time: now-60, value: slPrice }, { time: now+10, value: slPrice }]);
            lineTP.setData([{ time: now-60, value: tpPrice }, { time: now+10, value: tpPrice }]);
        } else {
            lineEntry.setData([]); lineSL.setData([]); lineTP.setData([]);
        }

        if (missions.m15) mLineM15.setData([{ time: now-60, value: missions.m15 }, { time: now+10, value: missions.m15 }]);
        if (missions.m5) mLineM5.setData([{ time: now-60, value: missions.m5 }, { time: now+10, value: missions.m5 }]);
        if (missions.m1) mLineM1.setData([{ time: now-60, value: missions.m1 }, { time: now+10, value: missions.m1 }]);

    } catch (e) { console.error("Engine Step Error"); }
}

/* ================= WS & DATA ================= */
function connect() {
    ws = new WebSocket(WS_URL);
    ws.onopen = () => { document.getElementById("debug").textContent = "SYSTEM ONLINE"; logMsg("WS CONNECTED"); };
    ws.onmessage = e => {
        try {
            const d = JSON.parse(e.data);
            const raw = parseFloat(d.p);
            lastTick = Date.now();
            document.getElementById("price").textContent = raw.toFixed(2);
            document.getElementById("raw").textContent = "RAW: " + raw.toFixed(4);
            updateEngine(raw);
        } catch (err) { }
    };
    ws.onclose = () => { setTimeout(connect, 2000); };
}

fetch("https://api.binance.com/api/v3/klines?symbol=PAXGUSDT&interval=1m&limit=100")
    .then(r => r.json()).then(d => {
        candleSeries.setData(d.map(x => ({ time: x[0]/1000, open: +x[1], high: +x[2], low: +x[3], close: +x[4] })));
        connect();
    });

setInterval(() => { if (Date.now() - lastTick > 5000) document.getElementById("debug").textContent = "IDLE (NO DATA)"; }, 1000);
window.addEventListener("resize", () => chart.resize(document.querySelector(".box").clientWidth, document.querySelector(".box").clientHeight));
</script>
</body>
</html>
