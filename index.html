<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>XAU PREDATOR â€“ STABLE ENGINE</title>
<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
<style>
:root{
  --bg:#050505;--card:#111;--text:#eee;--accent:#00ffff;
  --wait:#444;--arming:#ffcc00;--enter:#00ff66;--locked:#ff4444;
  --h1:#bf00ff;--m15:#ffff00;--m5:#00ff00;--m1:#ffffff;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;outline:none}
body{
  margin:0;background:var(--bg);color:var(--text);
  font-family:Consolas,monospace;height:100vh;overflow:hidden;
  display:flex;flex-direction:column;padding:8px;user-select:none;
}
.grid{display:grid;grid-template-rows:1fr auto;gap:8px;height:100%}
.box{background:var(--card);border:1px solid #333;border-radius:8px;overflow:hidden;position:relative}
#chart{width:100%;height:100%}
.ind{position:absolute;bottom:0;left:0;height:6px;width:100%;background:var(--wait);transition:0.3s;z-index:10}
.sidebar{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.card{background:#000;border:1px solid #222;border-radius:6px;padding:8px;text-align:center}
.label{font-size:10px;color:#666;text-transform:uppercase;letter-spacing:1px}
.val{font-size:18px;font-weight:bold}
#price{font-size:28px;color:var(--accent)}
#reason{grid-column:span 2;color:var(--arming);min-height:36px;display:flex;align-items:center;justify-content:center;font-size:11px;padding:4px}
#debug{grid-column:span 2;font-size:10px;color:#00ff66;background:#001a00;padding:4px}
#log{grid-column:span 2;height:85px;overflow-y:auto;font-size:11px;color:#00ff66;text-align:left;border:1px solid #222;padding:4px;background:#050505}
.btns{grid-column:span 2;display:grid;grid-template-columns:1fr 1fr;gap:6px}
.btn{padding:16px;border:none;border-radius:6px;font-weight:bold;color:#fff;opacity:0.15;transition:0.2s;font-size:14px;cursor:pointer}
.buy{background:#00ff66;color:#000}
.sell{background:#ff4444;color:#fff}
.active{opacity:1;box-shadow:0 0 20px currentColor;transform:scale(0.98);border:2px solid #fff}
</style>
</head>
<body>
<div class="grid">
  <div class="box"><div id="chart"></div><div id="ind" class="ind"></div></div>
  <div class="sidebar">
    <div class="card" style="grid-column:span 2">
      <div id="price" class="val">0.00</div>
      <div id="raw" style="font-size:10px;color:#444">RAW: 0.0000</div>
    </div>
    <div class="card"><div class="label">Bias</div><div id="bias" class="val">-</div></div>
    <div class="card"><div class="label">State</div><div id="state" class="val">WAIT</div></div>
    <div id="reason" class="card">ENGINE READY...</div>
    <div id="log" class="card"></div>
    <div id="debug" class="card">STATUS: POLLING ACTIVE</div>
    <div class="btns">
      <button id="buyBtn" class="btn buy" onclick="manualTrigger('BUY')">EXECUTE BUY</button>
      <button id="sellBtn" class="btn sell" onclick="manualTrigger('SELL')">EXECUTE SELL</button>
    </div>
  </div>
</div>

<script>
/* ================= ENGINE CORE & LOGISTIK (REST) ================= */
let lastTick=0, state="WAIT", bias="WAIT", lastState="WAIT";
let rawHigh=0, rawLow=0, smoothPrice=0;
let entryPrice=0, slPrice=0, tpPrice=0;
let missions = { h1: 0, m15: 0, m5: 0, m1: 0 };

/* ================= CHART CONFIG ================= */
const chart = LightweightCharts.createChart(document.getElementById("chart"), {
    layout: { backgroundColor: "#050505", textColor: "#d1d4dc" },
    grid: { vertLines: { color: "#111" }, horzLines: { color: "#111" } },
    timeScale: { timeVisible: true, secondsVisible: true },
    crosshair: { mode: LightweightCharts.CrosshairMode.Normal }
});
const candleSeries = chart.addCandlestickSeries();
const zU = chart.addLineSeries({ color: "rgba(255,255,255,0.05)", title: 'Zone High' });
const zL = chart.addLineSeries({ color: "rgba(255,255,255,0.05)", title: 'Zone Low' });
const lineEntry = chart.addLineSeries({ color: "#00ffff", lineStyle: 2, title: 'ENTRY' });
const lineSL = chart.addLineSeries({ color: "#ff4444", lineStyle: 3, title: 'SL' });
const lineTP = chart.addLineSeries({ color: "#00ff66", lineStyle: 3, title: 'TP' });

// Mission Price (High Accuracy Colors)
const mLineH1 = chart.addLineSeries({ color: "#bf00ff", lineWidth: 2 });  // Purple
const mLineM15 = chart.addLineSeries({ color: "#ffff00", lineWidth: 2 }); // Yellow
const mLineM5 = chart.addLineSeries({ color: "#00ff00", lineWidth: 2 });  // Green
const mLineM1 = chart.addLineSeries({ color: "#ffffff", lineWidth: 2 });  // White

function logMsg(m){
    const logEl = document.getElementById("log");
    const d = document.createElement("div");
    d.textContent = `[${new Date().toLocaleTimeString()}] ${m}`;
    logEl.prepend(d);
    if(logEl.childNodes.length > 50) logEl.removeChild(logEl.lastChild);
}

function beep(freq = 880) {
    try {
        const a = new (window.AudioContext || window.webkitAudioContext)();
        const o = a.createOscillator(); const g = a.createGain();
        o.connect(g); g.connect(a.destination); o.frequency.value = freq;
        g.gain.value = 0.05; o.start(); o.stop(a.currentTime + 0.1);
    } catch(e){}
}

/* ================= EXECUTION & STATE MACHINE ================= */
function manualTrigger(dir) {
    if (state === "LOCKED") { state = "WAIT"; entryPrice = 0; logMsg("ENGINE RESET"); return; }
    state = "LOCKED";
    entryPrice = smoothPrice;
    const offset = 0.40;
    slPrice = dir === "BUY" ? entryPrice - offset : entryPrice + offset;
    tpPrice = dir === "BUY" ? entryPrice + (offset * 2) : entryPrice - (offset * 2);
    beep(1200); navigator.vibrate?.([300, 100, 300]);
    logMsg(`EXECUTED: ${dir} @ ${entryPrice.toFixed(2)}`);
}

function updateEngine(raw) {
    smoothPrice = smoothPrice ? smoothPrice * 0.8 + raw * 0.2 : raw;
    const now = Math.floor(Date.now() / 1000);

    // High Accuracy Range & Mission Price
    if (!rawHigh || smoothPrice > rawHigh) { rawHigh = smoothPrice; missions.h1 = rawHigh + 0.3; }
    if (!rawLow || smoothPrice < rawLow) { rawLow = smoothPrice; missions.m1 = (rawHigh+rawLow)/2; }
    
    const range = rawHigh - rawLow;
    missions.m15 = rawLow + (range * 0.75);
    missions.m5 = rawLow + (range * 0.25);
    missions.m1 = (rawHigh + rawLow) / 2;

    bias = (smoothPrice > missions.m1) ? "BUY" : "SELL";

    if (state !== "LOCKED") {
        const target = bias === "BUY" ? missions.m15 : missions.m5;
        if (Math.abs(smoothPrice - target) < 0.10) state = "ENTER";
        else if (Math.abs(smoothPrice - target) < 0.20) state = "ARMING";
        else state = "WAIT";
    }

    // UI & Alerts
    document.getElementById("price").textContent = raw.toFixed(2);
    document.getElementById("raw").textContent = "RAW: " + raw.toFixed(4);
    document.getElementById("bias").textContent = bias;
    document.getElementById("bias").style.color = bias === "BUY" ? "#00ff66" : "#ff4444";
    document.getElementById("state").textContent = state;
    document.getElementById("ind").style.background = `var(--${state.toLowerCase()})`;
    document.getElementById("reason").textContent = state === "ENTER" ? "MISSION REACHED - FIRE!" : "SCANNING HABIT...";
    
    document.getElementById("buyBtn").className = `btn buy ${state === "ENTER" && bias === "BUY" ? "active" : ""}`;
    document.getElementById("sellBtn").className = `btn sell ${state === "ENTER" && bias === "SELL" ? "active" : ""}`;

    if(state === "ENTER" && lastState !== "ENTER") { beep(660); navigator.vibrate?.(200); logMsg("PREDATOR ENTER ZONE!"); }
    lastState = state;

    // Chart Update
    zU.setData([{ time: now-60, value: rawHigh }, { time: now+10, value: rawHigh }]);
    zL.setData([{ time: now-60, value: rawLow }, { time: now+10, value: rawLow }]);
    mLineM15.setData([{ time: now-60, value: missions.m15 }, { time: now+10, value: missions.m15 }]);
    mLineM5.setData([{ time: now-60, value: missions.m5 }, { time: now+10, value: missions.m5 }]);
    mLineM1.setData([{ time: now-60, value: missions.m1 }, { time: now+10, value: missions.m1 }]);
    
    if (state === "LOCKED") {
        lineEntry.setData([{ time: now-60, value: entryPrice }, { time: now+10, value: entryPrice }]);
        lineSL.setData([{ time: now-60, value: slPrice }, { time: now+10, value: slPrice }]);
        lineTP.setData([{ time: now-60, value: tpPrice }, { time: now+10, value: tpPrice }]);
    } else {
        lineEntry.setData([]); lineSL.setData([]); lineTP.setData([]);
    }
}

/* ================= AMUNISI (POLLING REST) ================= */
async function pollPrice() {
    try {
        const r = await fetch("https://fapi.binance.com/fapi/v1/ticker/price?symbol=PAXGUSDT");
        const d = await r.json();
        lastTick = Date.now();
        updateEngine(parseFloat(d.price));
    } catch(e) { document.getElementById("debug").textContent = "STATUS: DATA DELAY"; }
}

// History & Start
fetch("https://fapi.binance.com/fapi/v1/klines?symbol=PAXGUSDT&interval=1m&limit=100")
    .then(r => r.json()).then(d => {
        candleSeries.setData(d.map(x => ({ time: x[0]/1000, open: +x[1], high: +x[2], low: +x[3], close: +x[4] })));
        logMsg("HISTORY LOADED");
        setInterval(pollPrice, 450); // Interval stabil buat Android
    });

window.addEventListener("resize", () => chart.resize(document.querySelector(".box").clientWidth, document.querySelector(".box").clientHeight));
</script>
</body>
  </html>
