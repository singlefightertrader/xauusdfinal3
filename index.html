<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>XAU V11 â€“ ABSOLUTE SNIPER SYSTEM</title>
    <style>
        :root {
            --h1: #BF40BF; --m30: #0000FF; --m15: #FFFF00; --m5: #00FF00; --m1: #FFFFFF;
            --bg: #000; --cyan: #00ffff; --fire: #ff0000; --wait: #ffcc00;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; background: var(--bg); color: #fff; font-family: 'Courier New', monospace; overflow: hidden; height: 100vh; }

        /* STATUS BAR */
        #status-bar {
            position: fixed; top: 0; width: 100%; height: 70px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 1000; background: #0a0a0a; border-bottom: 3px solid #333;
        }
        #state-text { font-size: 24px; font-weight: 900; letter-spacing: 2px; }
        #active-tf-display { font-size: 14px; color: var(--cyan); font-weight: bold; margin-top: 2px; }

        .enter-mode { background: var(--fire) !important; color: #fff !important; animation: pulse 0.4s infinite alternate; }
        @keyframes pulse { from { opacity: 1; } to { opacity: 0.7; } }

        /* CHART & OVERLAY */
        #main-container { position: relative; width: 100%; height: calc(100% - 150px); margin-top: 70px; z-index: 1; }
        iframe { width: 100%; height: 100%; border: none; }
        
        #chart-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10;
        }
        .price-line {
            position: absolute; left: 0; width: 100%; height: 2px;
            display: flex; align-items: center; justify-content: flex-end;
            transition: top 0.1s linear;
        }
        .price-line span { font-size: 11px; font-weight: bold; background: #000; padding: 2px 6px; border: 1px solid; margin-right: 80px; }

        /* MISSION PANEL */
        #mission-panel {
            position: fixed; right: 10px; top: 160px; width: 200px;
            background: rgba(0,0,0,0.9); border: 1px solid #333;
            padding: 10px; z-index: 500; display: flex; flex-direction: column; gap: 5px;
        }
        .m-row { padding: 6px; border-left: 5px solid; background: rgba(255,255,255,0.05); font-size: 11px; transition: 0.3s; }
        .active-target { box-shadow: 0 0 15px var(--cyan); border-right: 3px solid #fff; transform: scale(1.05); z-index: 10; }

        /* FOOTER & SYNC */
        #footer {
            position: fixed; bottom: 0; width: 100%; height: 80px;
            background: #000; border-top: 2px solid #222;
            display: flex; align-items: center; padding: 0 15px; z-index: 1000;
        }
        #price-box { flex: 1; }
        .label { font-size: 10px; color: #888; text-transform: uppercase; }
        .val { font-size: 26px; font-weight: 900; color: var(--cyan); }

        /* EXECUTION BUTTONS */
        #action-box { display: flex; gap: 10px; flex: 1.5; justify-content: flex-end; }
        .btn-ex {
            width: 110px; height: 55px; border: none; border-radius: 6px;
            font-size: 20px; font-weight: 900; opacity: 0.1; pointer-events: none;
            cursor: pointer;
        }
        .btn-buy { background: #00ff66; color: #000; }
        .btn-sell { background: var(--fire); color: #fff; }
        .ready { opacity: 1 !important; pointer-events: auto !important; }

        #sync-btn { background: #222; color: var(--cyan); border: 1px solid var(--cyan); padding: 10px; font-weight: bold; margin-right: 15px; border-radius: 4px; }

        #sync-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 2000;
            display: none; align-items: center; justify-content: center;
        }
        .modal-box { background: #111; padding: 30px; border: 2px solid var(--cyan); width: 90%; max-width: 400px; text-align: center; }
        input { width: 100%; background: #000; color: var(--cyan); border: 1px solid #444; padding: 15px; font-size: 24px; text-align: center; margin: 20px 0; }

        /* LOCK SCREEN */
        #lock-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.98); z-index: 5000; display: none;
            align-items: center; justify-content: center; font-size: 30px; font-weight: 900; color: var(--fire); text-align: center;
        }

        .patch-mission-btn {
            position: fixed; bottom: 90px; left: 10px; z-index: 9999;
            background: #111; color: var(--cyan); border: 1px solid var(--cyan);
            padding: 8px 10px; font-size: 10px; font-weight: bold; border-radius: 4px;
        }
    </style>
</head>
<body>

<div id="status-bar">
    <div id="state-text">CONNECTING...</div>
    <div id="active-tf-display">WAITING FOR DATA</div>
</div>

<div id="main-container">
    <div id="chart-overlay"></div>
    <iframe id="tv-chart" src="https://s.tradingview.com/widgetembed/?symbol=OANDA:XAUUSD&interval=1&theme=dark"></iframe>
</div>

<div id="mission-panel">
    <div class="m-row" id="row-h1" style="border-color: var(--h1)">H1: --</div>
    <div class="m-row" id="row-m30" style="border-color: var(--m30)">M30: --</div>
    <div class="m-row" id="row-m15" style="border-color: var(--m15)">M15: --</div>
    <div class="m-row" id="row-m5" style="border-color: var(--m5)">M5: --</div>
    <div class="m-row" id="row-m1" style="border-color: var(--m1)">M1: --</div>
</div>

<div id="footer">
    <button id="sync-btn" onclick="openSync()">SYNC MT5</button>
    <div id="price-box">
        <div class="label">REAL PRICE (MT5)</div>
        <div id="real-price-val" class="val">0.00</div>
    </div>
    <div id="action-box">
        <button id="btn-buy" class="btn-ex btn-buy" onclick="fire('BUY')">BUY</button>
        <button id="btn-sell" class="btn-ex btn-sell" onclick="fire('SELL')">SELL</button>
    </div>
</div>

<div id="sync-modal">
    <div class="modal-box">
        <div style="color:var(--cyan); font-weight:bold;">SINKRONISASI MT5 (OFFSET LOCK)</div>
        <input type="number" id="mt5-val" step="0.01" placeholder="Harga di MT5">
        <button onclick="saveSync()" style="width:100%; background:var(--cyan); border:none; padding:15px; font-weight:bold; cursor:pointer;">LOCK REALITY</button>
    </div>
</div>

<div id="lock-overlay">TARGET EXECUTED<br>SYSTEM LOCKED</div>

<script>
    const WS_URL = "wss://xauusdsuperfinal.sapammeded.workers.dev/";
    const TF_LIST = ['m1', 'm5', 'm15', 'm30', 'h1'];
    
    let ws;
    let engineBid = 0;
    let mt5Offset = 0;
    let isLocked = false;
    let lastAlert = 0;
    let currentActiveTF = 'm1';

    // --- HOLD TIME & NOTIFICATION STATE ---
    let enterHoldStart = null;
    const ENTER_HOLD_MS = 1200;
    const ENTER_RADIUS = 0.20;
    let notificationLocked = false;
    let spikeValidState = false; 

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    window.__MISSION_PATCH__ = {
        visible: true,
        mt5Offset: null,
        lastM5Bucket: null,
        lockedMission: {}
    };

    // --- GENERATE SW.JS BLOB ON THE FLY ---
    const swCode = `
    self.addEventListener('install', e => self.skipWaiting());
    self.addEventListener('activate', e => e.waitUntil(self.clients.claim()));
    self.addEventListener('notificationclick', e => {
        e.notification.close();
        e.waitUntil(clients.matchAll({type:'window'}).then(cl => {
            if(cl.length > 0) return cl[0].focus();
            return clients.openWindow('/');
        }));
    });`;
    const swBlob = new Blob([swCode], {type: 'application/javascript'});
    const swUrl = URL.createObjectURL(swBlob);

    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register(swUrl).catch(err => console.log("SW Error", err));
    }

    function openSync() { document.getElementById('sync-modal').style.display = 'flex'; }
    
    function saveSync() {
        const val = parseFloat(document.getElementById('mt5-val').value);
        if (val && engineBid) {
            mt5Offset = val - engineBid;
            window.__MISSION_PATCH__.mt5Offset = mt5Offset;
            document.getElementById('sync-modal').style.display = 'none';
            if(ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ cmd: "RE_SCAN", syncPrice: val }));
            }
        }
    }

    function beep() {
        if (Date.now() - lastAlert < 4000) return;
        lastAlert = Date.now();
        if (navigator.vibrate) navigator.vibrate([200, 100, 200, 100, 200, 100, 200]);
        for(let i=0; i<4; i++) {
            setTimeout(() => {
                const o = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                o.connect(g); g.connect(audioCtx.destination);
                o.type = 'square'; o.frequency.value = 1000;
                g.gain.value = 0.1; o.start(); o.stop(audioCtx.currentTime + 0.1);
            }, i * 250);
        }
    }

    // ENHANCED HOLD FILTER LOGIC (FITUR 2: SPIKE MODE)
    function validateHoldEnter(state, currentPrice, missionData, tf) {
        if (state !== "ENTER" || !missionData || !missionData[tf]) {
            enterHoldStart = null;
            spikeValidState = false;
            return false;
        }
        const rawTarget = parseFloat(missionData[tf]);
        if (isNaN(rawTarget)) return false;
        
        const realTarget = rawTarget + mt5Offset;
        const dist = Math.abs(realTarget - currentPrice);

        // Jika harga sudah menyentuh (dist dekat) lalu spike cepat menjauh tapi state masih ENTER
        if (dist <= ENTER_RADIUS) {
            spikeValidState = true; // Penanda Institusi/Bandar pernah menyentuh
            if (!enterHoldStart) enterHoldStart = Date.now();
        }

        // Logic normal: hold time tercapai ATAU Spike Mode: pernah sentuh & masih di zona state ENTER
        const isTimeMet = enterHoldStart && (Date.now() - enterHoldStart) >= ENTER_HOLD_MS;
        return isTimeMet || (spikeValidState && state === "ENTER");
    }

    // NOTIFICATION LOGIC (FITUR 1)
    function sendSniperNotification(bias, tf, price) {
        if (Notification.permission === 'granted' && !notificationLocked && !isLocked) {
            const title = "ðŸ”¥ GOLD XAUUSD READY";
            const options = {
                body: `ENTER ${bias} â€“ TF ${tf.toUpperCase()}\nHarga: ${price.toFixed(2)}`,
                icon: 'https://cdn-icons-png.flaticon.com/512/2533/2533031.png',
                vibrate: [200, 100, 200],
                tag: 'sniper-entry',
                renotify: true,
                requireInteraction: true
            };
            navigator.serviceWorker.ready.then(reg => reg.showNotification(title, options));
            notificationLocked = true; // Anti Spam (Reset on Arming/Wait)
        }
    }

    function resolveMission(tf, rawPrice) {
        const patch = window.__MISSION_PATCH__;
        if (patch.mt5Offset === null) return null;
        const nowBucket = Math.floor(Date.now() / 300000);
        if (nowBucket === patch.lastM5Bucket && patch.lockedMission[tf]) return patch.lockedMission[tf];
        const realMission = rawPrice + patch.mt5Offset;
        patch.lockedMission[tf] = realMission;
        patch.lastM5Bucket = nowBucket;
        return realMission;
    }

    function drawMissionLine(tf, engineMission, enginePrice) {
        const overlay = document.getElementById('chart-overlay');
        if (!overlay || !window.__MISSION_PATCH__.visible) return;
        const color = getComputedStyle(document.documentElement).getPropertyValue(`--${tf}`).trim();
        const diff = (engineMission - enginePrice) * 20; 
        const top = (overlay.offsetHeight / 2) - diff;

        const line = document.createElement('div');
        line.className = 'price-line';
        line.style.width = '100%';
        line.style.top = top + 'px';
        line.style.borderTop = `2px ${tf === currentActiveTF ? 'solid' : 'dashed'} ${color}`;
        line.style.zIndex = (tf === currentActiveTF) ? '15' : '10';
        
        const realVal = engineMission + (window.__MISSION_PATCH__.mt5Offset || 0);
        line.innerHTML = `<span style="border-color:${color}; color:${color}; background:rgba(0,0,0,0.8); right:0; position:absolute;">${tf.toUpperCase()} ${realVal.toFixed(2)}</span>`;
        overlay.appendChild(line);
    }

    function connect() {
        ws = new WebSocket(WS_URL);
        ws.onmessage = (e) => {
            const data = JSON.parse(e.data);
            if (data.type !== "TICK" || isLocked) return;

            engineBid = parseFloat(data.bid);
            const REAL_PRICE = engineBid + mt5Offset;
            document.getElementById('real-price-val').innerText = REAL_PRICE.toFixed(2);

            const state = data.discretionaryZone?.state;
            const bar = document.getElementById('status-bar');
            const btns = document.querySelectorAll('.btn-ex');
            const stateText = document.getElementById('state-text');

            // FITUR 3: MULTI TIMEFRAME AWARENESS
            let tfEnterTriggered = validateHoldEnter(state, REAL_PRICE, data.mission, currentActiveTF);
            
            // Background check for other TFs for notifications
            if (!tfEnterTriggered && !notificationLocked) {
                for (let tf of TF_LIST) {
                    if (tf === currentActiveTF) continue;
                    if (validateHoldEnter(state, REAL_PRICE, data.mission, tf)) {
                        sendSniperNotification(data.discretionaryZone.bias, tf, REAL_PRICE);
                        break;
                    }
                }
            }

            if (tfEnterTriggered) {
                bar.className = "enter-mode";
                stateText.innerText = `ENTER ${data.discretionaryZone.bias} (${currentActiveTF.toUpperCase()})`;
                btns.forEach(b => b.classList.add('ready'));
                
                // M1 specific alert (Fitur 3)
                if (currentActiveTF === 'm1') beep();
                
                sendSniperNotification(data.discretionaryZone.bias, currentActiveTF, REAL_PRICE);
            } else if (state === "ARMING") {
                bar.className = "";
                stateText.innerText = `ARMING... (${currentActiveTF.toUpperCase()})`;
                btns.forEach(b => b.classList.remove('ready'));
                notificationLocked = false; 
            } else {
                bar.className = "";
                stateText.innerText = `WAIT / ARMING (${currentActiveTF.toUpperCase()})`;
                btns.forEach(b => b.classList.remove('ready'));
                notificationLocked = false;
            }

            // MISSION RENDERER
            if (data.mission && mt5Offset !== null) {
                const overlay = document.getElementById('chart-overlay');
                if (overlay) overlay.innerHTML = '';
                TF_LIST.forEach(tf => {
                    const raw = data.mission[tf];
                    const row = document.getElementById('row-' + tf);
                    if (raw === 'ACHIEVED' || isNaN(raw)) {
                        if(row) { row.innerHTML = `${tf.toUpperCase()}: ACHIEVED`; row.style.opacity = '0.3'; }
                        return;
                    }
                    const realMission = resolveMission(tf, parseFloat(raw));
                    if (!realMission) return;
                    drawMissionLine(tf, parseFloat(raw), engineBid);
                    if (row) {
                        const direction = realMission > REAL_PRICE ? "â–² BUY" : "â–¼ SELL";
                        row.innerHTML = `<b>${tf.toUpperCase()}</b>: ${realMission.toFixed(2)}<br>${direction}`;
                        row.style.opacity = '1';
                        row.style.background = (tf === currentActiveTF) ? 'rgba(255,255,255,0.15)' : 'rgba(255,255,255,0.05)';
                    }
                });

                const tfDisplay = document.getElementById('active-tf-display');
                if (tfDisplay) {
                    tfDisplay.innerText = `CONTEXT: ${currentActiveTF.toUpperCase()} | MONITORING ALL TF`;
                    tfDisplay.style.color = getComputedStyle(document.documentElement).getPropertyValue(`--${currentActiveTF}`);
                }
            }
        };
        ws.onclose = () => setTimeout(connect, 2000);
    }

    // FITUR 4: MODE LOCK TOTAL
    function fire(side) {
        if (isLocked) return;
        if (audioCtx.state === 'suspended') audioCtx.resume();
        
        isLocked = true; // Lock Total
        notificationLocked = true; // Stop notifications
        
        document.getElementById('lock-overlay').style.display = 'flex';
        
        // Disable UI
        document.querySelectorAll('.btn-ex').forEach(b => b.classList.remove('ready'));
        
        if(ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ 
                cmd: "ENTRY", side: side, price: engineBid, 
                realPrice: engineBid + mt5Offset, tf: currentActiveTF 
            }));
        }
    }

    // Permission Trigger
    document.addEventListener('click', () => {
        if (Notification.permission !== 'granted') Notification.requestPermission();
        if (audioCtx.state === 'suspended') audioCtx.resume();
    }, { once: true });

    document.addEventListener('click', (e) => {
        if (isLocked) return;
        const text = e.target.innerText ? e.target.innerText.toLowerCase() : '';
        if (TF_LIST.includes(text)) {
            currentActiveTF = text;
            enterHoldStart = null;
            spikeValidState = false;
        }
    });

    (function initMissionBtn() {
        const btn = document.createElement('button');
        btn.innerText = 'MISSION';
        btn.className = 'patch-mission-btn';
        btn.onclick = () => {
            window.__MISSION_PATCH__.visible = !window.__MISSION_PATCH__.visible;
            document.querySelectorAll('#mission-panel, #chart-overlay')
                .forEach(el => el.style.display = window.__MISSION_PATCH__.visible ? '' : 'none');
        };
        document.body.appendChild(btn);
    })();

    connect();
</script>
</body>
</html>
